<html>
  <head>
    <link type="text/css" rel="stylesheet" href="../style/main.css" />
    <link type="text/css" rel="stylesheet" href="../style/Form_Dlg.css" />
  </head>

  <script type="module">
    import Utils from "../lib/Utils.js";
    import Admin from "../lib/Admin.js";
    import "../component/Form_Buddy.mjs";
    import "../component/Form_Dlg.mjs";
    import "../component/Input_Span.mjs";

    Main();
    async function Main()
    {
      await Admin.Import_API();

      show_add_btn.addEventListener("click", prop_dlg.On_New);
      prop_dlg.addEventListener("save", On_Click_Save);

      Table_Load();
    }

    async function On_Click_Save()
    {
      const property = prop_dlg.data;
      if (property)
      {
        const id = await Property.Save(property);
        if (id)
        {
          Table_Load();
        }
        else
        {
          Utils.Handle_Errors(Property);
        }
      }
    }

    async function Table_Load()
    {
      table.value = await Property.Select();
    }

    class DE_Table extends HTMLElement 
    {
      static tname = "de-table";

      constructor()
      {
        super();
        Utils.Bind(this, "On_");
      }

      set value(objs)
      {
        for (const obj of objs)
        {
          const body_row = document.createElement("tr");
          this.body.append(body_row);

          const cols = this.head_row.querySelectorAll("th[name]");
          for (const col of cols)
          {
            const field_name = col.getAttribute("name");
            const field_value = obj[field_name];

            const row_cell = document.createElement("td");
            body_row.append(row_cell);

            row_cell.innerText = field_value;
          }
        }
      }

      connectedCallback()
      {
        this.Render();
      }

      Reload()
      {

      }

      Render()
      {
        const cols = [...this.children];
        this.innerHTML = `
          <table>
            <thead>
              <tr cid="head_row"></tr>
            </thead>
            <tbody cid="body">
            </tbody>
            <tfooter>
              <tr></tr>
            </tfooter>
          </table>
        `;
        Utils.Set_Id_Shortcuts(this, this, "cid");

        this.Render_Head_Row(cols);
      }

      Render_Head_Row(cols)
      {
        for (const col of cols)
        {
          const th = document.createElement("th");
          this.head_row.append(th);

          th.append(...col.childNodes);
          th.setAttribute("name", col.getAttribute("name"));
        }
      }
    }
    Utils.Register_Element(DE_Table);
    //export default DE_Header;
  </script>

  <body>
    <header>
      <h1>Properties</h1>
      <button id="show_add_btn">+</button>
    </header>

    <de-table id="table">
      <de-th name="id">Id.</de-th>
      <de-th name="address">Address</de-th>
    </de-table>
    
    <form-dlg id="prop_dlg" title-text="Apartment Details">
      <label for="id_input">ID</label>
      <input-span id="id_input" name="id" placeholder="N/A"></input-span>
      <label for="addr_input">Address</label>
      <input id="addr_input" name="address" type="text">
    </form-dlg>

  </body>
</html>